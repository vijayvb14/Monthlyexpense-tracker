<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Expense Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial;
  background: linear-gradient(135deg,#1e3c72,#c31432);
}
.app {
  background: white;
  max-width: 420px;
  margin: auto;
  padding: 15px;
  border-radius: 16px;
}
label {
  font-size: 13px;
  font-weight: bold;
  margin-top: 10px;
  display: block;
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
}
button {
  background: #333;
  color: white;
  border: none;
  border-radius: 10px;
}
.section {
  background: #f4f6fa;
  padding: 10px;
  border-radius: 10px;
  margin-top: 10px;
}
canvas {
  margin-top: 15px;
}
</style>
</head>

<body>

<div class="app">
<h3>ðŸ’° Expense Tracker</h3>

<label>Month</label>
<input type="month" id="month">

<label>Type</label>
<select id="type" onchange="onContextChange()">
  <option>Personal</option>
  <option>Office</option>
  <option>House Build</option>
</select>

<label>Category</label>
<select id="category"></select>

<label>Amount</label>
<input type="number" id="amount">

<button onclick="addAmount()">âž• Add Amount</button>
<button onclick="spendAmount()">ðŸ’¸ Spend</button>

<div class="section">
  <b>Balance:</b> â‚¹ <span id="balance">0</span>
</div>

<button onclick="exportMonth()">ðŸ“¤ Export This Month</button>
<button onclick="exportAll()">ðŸ“¦ Export Full Sheet</button>

<hr>

<h4>ðŸ“Š Trend Chart</h4>

<select onchange="drawChart(this.value)">
  <option value="Personal">Personal</option>
  <option value="Office">Office</option>
  <option value="House Build">House Build</option>
</select>

<canvas id="trendChart" height="220"></canvas>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbw86LrjosFZIAdrwmebSOku_mBhRBbdbrvxnoPSNnUi6nyLevr3XCgOsU8AWazXknzHTg/exec";
const SHEET_ID = "14DntGpbPle9sA2jonUKSA14JzUixUG4Kx5etfNNSIok";

/* ================= CATEGORY MAP ================= */
const categoryMap = {
  Personal: ["Food","Rent","Friends","Home","Others"],
  Office: ["Card","Game"],
  "House Build": [
    "Borewell Work","EB","Loan","Service Wire","Sand","3/4 Jali",
    "Motor and Pipe","Pipe Work","JCB Pillar Work Bore","Iron",
    "Switch Board","Cement","Jali","Cement Bricks","Gravel",
    "Earth Beam","Brick","Red Face Brick","Wood Work",
    "JCB Septic Tank","Vehicle","River Sand","Door Clamp",
    "Loan CR","Loan DR","PF","Salary","Miscellaneous"
  ]
};
const categories = categoryMap;
let chart;
let summaryData;

/* INIT */
month.value = new Date().toISOString().slice(0,7);
loadCategories();
refreshBalance();
loadSummary();

/* CATEGORY */
function loadCategories() {
  category.innerHTML = "";
  categoryMap[type.value].forEach(c =>
    category.add(new Option(c,c))
  );
}

/* SAVE */
function addAmount() {
  saveTxn(Number(amount.value), 0);
}
function spendAmount() {
  saveTxn(0, Number(amount.value));
}

function saveTxn(cr, dr) {
  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify({
      month: month.value,
      type: type.value,
      category: category.value,
      credit: cr,
      debit: dr
    })
  }).then(() => {
    setTimeout(() => {
      refreshBalance();
      loadSummary();
    }, 600);
  });
}

/* BALANCE */
function refreshBalance() {
  fetch(API_URL)
    .then(r => r.json())
    .then(d => {
      summaryData = d.summary;
      let bal = 0;

      if (type.value === "House Build") {
        bal = summaryData.HouseBuild.balance || 0;
      } else {
        bal = summaryData[type.value]?.[month.value]?.balance || 0;
      }

      document.getElementById("balance").innerText = bal;
    });
}

/* SUMMARY */
function loadSummary() {
  fetch(API_URL)
    .then(r => r.json())
    .then(d => {
      summaryData = d.summary;
      drawChart(type.value);
    });
}

/* CHART */
function drawChart(t) {
  if (!summaryData) return;

  if (chart) chart.destroy();

  if (t === "House Build") {
    chart = new Chart(trendChart,{
      type:"bar",
      data:{
        labels:["House Build"],
        datasets:[{
          label:"Total Balance",
          data:[summaryData.HouseBuild.balance],
          backgroundColor:"#4caf50"
        }]
      }
    });
    return;
  }

  const months = [];
  const values = [];

  const obj = summaryData[t] || {};
  Object.keys(obj).sort().forEach(m => {
    months.push(m);
    values.push(obj[m].debit);
  });

  chart = new Chart(trendChart,{
    type:"line",
    data:{
      labels: months,
      datasets:[{
        label: t + " Monthly Spend",
        data: values,
        borderColor:"#ff9800",
        fill:false,
        tension:0.3
      }]
    }
  });
}

/* EXPORT */
function exportAll() {
  window.open(
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=xlsx`
  );
}

function exportMonth() {
  alert("Use Excel filter: Month = " + month.value);
  exportAll();
}

function onContextChange() {
  loadCategories();
  refreshBalance();
}
</script>

</body>
</html>

